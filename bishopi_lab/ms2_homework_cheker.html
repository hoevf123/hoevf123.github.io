<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>ë¹„ìˆì´ ì‹¤í—˜ì‹¤</title>
    <link rel="stylesheet" href="common.css">
    <script src="w3-include-html.js"></script>
    <style>
        div.ms2-info-block{
            border: 1px solid #333333;
            padding:15px;
            border-radius: 15px;
            
        }
    </style>
</head>

<body>
    <div w3-include-html="nav-header.html"></div>
    <section>
        <div class="div-content">
            <h1>ìˆ™ì œ ê²€ì‚¬ê¸°</h1>
            <p>ë©”ì´í”ŒìŠ¤í† ë¦¬ì˜ ìˆ™ì œë¥¼ ê²€ì‚¬í•˜ëŠ” í”„ë¡œê·¸ë¨(?)ì˜ UI í…ŒìŠ¤íŠ¸ìš© ëª¨í˜•ì…ë‹ˆë‹¤.</p>
            <p>ì•„ë˜ì˜ ê²°ê³¼ ê°’ì€ í…ŒìŠ¤íŠ¸ ë°ì´í„°ì´ë©°, ì‹¤ì œ ìºë¦­í„° ì •ë³´ë¥¼ ë°›ì•„ì˜¤ë„ë¡ ë™ì‘í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë©´ <a href="https://maplestory2.nexon.com/Content/html/pop_policy.html">ë©”ì´í”ŒìŠ¤í† ë¦¬2 ìš´ì˜ì •ì±…</a>ì— ì˜í•´ ê³„ì • ì œì œ ì¡°ì¹˜ê°€ ì·¨í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <br/>
            
            <h2>ìˆ™ì œìˆ™ì œ</h2>
            <p>ì¶”í›„ ì¶”ê°€í•˜ê³  ì‹¶ì€ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
            <div class="ms2-frame border">
                <div class="ms2-frame homework-userinfo-display-area">
                    <h3>ìƒì„±ì¤‘...</h3>
                </div>
            </div>
            
            <!-- source code of createTag function -->
            <script type="text/javascript" src="createTag.js"></script>
            <!-- Data Warehouse from Python File-->
            <script>
                class DataWareHowse{
                    constructor(){
                        this.items={}
                    }
                    set(dict_keyworditems){
                        Object.assign(this.items, dict_keyworditems);
                    }
                    get(...key_names){
                        let multiple_argument_enable = true;
                        if(key_names.length<=1) multiple_argument_enable = false;
                        let ret_arrs = [];
                        for(let key in key_names){
                            key = key_names[key];
                            let ret_val = undefined;
                            try{
                                key = new String(key);
                                ret_val = this.items[key];
                            }catch(e){console.log(e);}
                            ret_arrs.push(ret_val);
                        }
                        ret_arrs = (multiple_argument_enable?ret_arrs:ret_arrs[0]); 
                        return ret_arrs;
                    }
                }
            </script>
            <!-- source code of character inventory implementation -->
            <script type="module">
                import {img_tag_formats,str_jobclasses} from "./ms2_datawarehouse_dungeon_datas.mjs";
                import {character_adventure_dungeon_reward_meso} from "./ms2_adventure_dungeon_bonus_reward_calculator.mjs";
                //DATA WAREHOUSE PREPARE
                const MAPLESTORY2_IMAGEPORTRAIT_DIR = "Maplestory2/Image/portrait/";


                //source copied from https://stackoverflow.com/questions/19706046/how-to-read-an-external-local-json-file-in-javascript
                /*
                // USAGE
                readTextFile("/Users/Documents/workspace/test.json", function(text){
                    var data = JSON.parse(text);
                    console.log(data);
                });
                */
                function readTextFile(file, callback) {
                    var rawFile = new XMLHttpRequest();
                    rawFile.overrideMimeType("application/json");
                    rawFile.open("GET", file, true);
                    rawFile.onreadystatechange = function() {
                        if (rawFile.readyState === 4 && rawFile.status == "200") {
                            callback(rawFile.responseText);
                        }
                    }
                    rawFile.send(null);
                }

                function readTextFile_Promise(fileName) {
                    return new Promise((resolve, reject)=>{
                        var rawFile = new XMLHttpRequest();
                        rawFile.overrideMimeType("application/json");
                        rawFile.open("GET", fileName, true);
                        rawFile.onreadystatechange = function() {
                            if (rawFile.readyState === 4 && rawFile.status == "200") {
                                resolve(rawFile.responseText);
                                console.log("1 Complete : ", rawFile.responseText);
                            }
                        }
                        rawFile.send(null);
                        //reject(null);
                    })
                    
                }

                

                // FILE READ CHECK
                

                // DEFINE RENDER METHOD AS PROMISE.
                function parseFileToJSON(text){
                    return new Promise((resolve, reject)=>{
                        try{
                            let jsonObject = JSON.parse(text);
                            console.log("2 Complete : ", jsonObject);
                            resolve(jsonObject);
                        }catch(e){
                            reject(e)
                        }
                    })
                }
                function JSONtoRender(json_data){
                    return new Promise((resolve, reject)=>{
                        let foo = document.getElementsByClassName("homework-userinfo-display-area"); // Root div elements.
                        // fit data
                        // make tag element(s)
                        // represent tags to the root div element(s).
                        //let assembled_html_tags=CreateSomething(json_data);
                        let assembled_html_tags=makeCharacterHTMLinfos(json_data);
                        console.log(assembled_html_tags);
                        Array.from(foo).forEach((e)=>{ 
                            e.innerHTML=""; //flush html elements
                            e.appendChild(assembled_html_tags);
                            //Array.from(assembled_html_tags[0]).forEach((result_elements)=>e.appendChild(result_elements));
                        });
                        console.log("3 Complete : ");
                        resolve(true);
                    })
                }
                let HTMLFrame_characeter_info = {
                    character_id:"p",
                    character_thumbnail_blob:"img",
                    trophy:"p"
                };
                const MAPLESTORY2_PROFILE_IMAGEPORTRAIT_DIR = undefined;
                const ICO_FILE_PREFIX = "ico"
                const ICO_FILE_EXTENSION = "png"
                const JOB_CLASS_IMGSRC_NAME_DICT = str_jobclasses?.reduce((a,c,i)=>{a.push([`${ICO_FILE_PREFIX}_${c["imgname"]}.${ICO_FILE_EXTENSION}`,c["name"]]); return a;},[]).reduce((a,c)=>{a[c[0]]=c[1]; return a;},{});
                console.log("hello, ",JOB_CLASS_IMGSRC_NAME_DICT);
                function get_filename(url){
                    const BACKSLASH = "\\";
                    const SLASH = "/";
                    let target_url = new String(url);
                    let pos_last_dir_loc = target_url.replace(BACKSLASH, SLASH).lastIndexOf(SLASH);
                    let ret_val = target_url.split(SLASH).pop();
                    return ret_val;
                }
                
                function replaceValueByKeyValue(target_value, keyValueSet){
                    if(!(keyValueSet instanceof Object))return target_value;
                    else return keyValueSet[target_value];
                }
                function get_job_class_name(img_url){
                    let ret_val = undefined;
                    try{
                        ret_val = replaceValueByKeyValue(img_url, JOB_CLASS_IMGSRC_NAME_DICT);
                    }catch(e){}
                    return ret_val;
                }
                function makeCharacterHTMLinfos(json_data){
                    let ret_val = undefined;
                    let root_div = document.createElement("div");
                    ret_val = root_div;

                    // 1-depth : id of chracter
                    for(let ch_id in json_data){
                        // Step 1. get Data
                        let character_name = json_data[ch_id]?.character_name;
                        let character_thumbnail_image_blob = json_data[ch_id]?.character_thumbnail_image_blob;
                        let character_job_class = json_data[ch_id]?.character_job_class;
                        character_job_class = get_filename(character_job_class);
                        character_job_class = get_job_class_name(character_job_class);
                        let achived_trophy_count = json_data[ch_id]?.trophy;
                        let dungeon_cleared_records = json_data[ch_id]?.dungeon_cleared_records;
                        let dungeon_cleared_summation_count = dungeon_cleared_records.reduce((a,c,i)=>{a = a + Number(c?.dungeon_cleared_amount) ?? 0; console.log(c?.dungeon_cleared_amount); return a;}, 0);
                        let dungeon_cleared_summation_score = dungeon_cleared_records.reduce((a,c,i)=>{a = a + Math.min(Number(c?.dungeon_cleared_amount) ?? 0, 300); return a;}, 0);
                        let dungeon_cleared_summation_max_score = dungeon_cleared_records.reduce((a,c,i)=>{a = a + 300; return a;}, 0);
                        let dungeon_cleared_summation_percentage_decimal = Math.round(dungeon_cleared_summation_score/dungeon_cleared_summation_max_score*10000)/100; //ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ í‘œí˜„
                        let dungeon_require_highest_level = dungeon_cleared_records.reduce((a,c,i)=>{let _curr_req_level = c?.["dungeon_info"]?.["dungeonReqLevel"]; if(Number.isInteger(_curr_req_level) && _curr_req_level>a) a = _curr_req_level; return a;},0);
                        let character_adventure_dungeon_earn_bonus_meso = character_adventure_dungeon_reward_meso(dungeon_require_highest_level);
                        let character_adventure_dungeon_clear_meso = dungeon_require_highest_level >= 70 ? 14000 : dungeon_require_highest_level >= 50 ? 10000 : 0; //ë„ëŠ” ë˜ì „ ì…ì¥ ì œí•œ ë ˆë²¨ * 200ë©”ì†Œ ì ìš©. 50ë ˆë²¨, 70ë ˆë²¨ ë˜ì „ë§Œ ëˆë‹¤ê³  ê°€ì •.
                        let character_adventure_dungeon_earn_meso = character_adventure_dungeon_clear_meso*30;
                        let today = new Date();
                        let today_year = today.getFullYear();
                        let today_month = today.getMonth() + 1;
                        let today_date = today.getDate();
                        
                        console.log("dungeon_require_highest_level :", dungeon_require_highest_level);
                        let remaining_day = (6-(today.getDay()+2)+7)%7;
                        let str_remaining_day_diplay = new String(remaining_day > 0 ? `${remaining_date} ì¼` : "24ì‹œê°„ ë¯¸ë§Œìœ¼ë¡œ");
                        // Step 2. make root div
                        let ch_root_div = createTag("div", "ms2-frame ms2-info-block " + new String(ch_id));
                        
                        // Step 3. inject fron data to HTML Tag Elements.
                        let _tags = {};
                        _tags.character_name = createTag("h1", "character-name",character_name);
                        _tags.character_thumbnail_image_blob = createTag("img", "characater_thumbnail_image");
                        _tags.character_thumbnail_image_blob.src = "data:image/png;base64,"+character_thumbnail_image_blob;
                        _tags.character_thumbnail_image_blob.alt = `characater_thumbnail_image(${new String(character_name)})`;
                        _tags.character_job_class=createTag("p","character-job-class",`ì§ì—… : ${new String(character_job_class)}`+ ` (ìºë¦­í„° ë ˆë²¨ ${dungeon_require_highest_level} ì´ìƒ)` ?? "");
                        if(Number.isFinite(character_adventure_dungeon_earn_bonus_meso))
                            _tags.character_adventure_dungeon_earn_meso = createTag("p", "character_adventure_dungeon_earn_meso", `ì´ ìºë¦­í„°ëŠ” ëª¨í—˜ ë˜ì „ 30íšŒë¥¼ ëŒì•„ í†µí•´ ìµœì†Œ 1ì£¼ ë‹¹ ${character_adventure_dungeon_earn_bonus_meso.toLocaleString('en-US')}ì˜ ë³´ë„ˆìŠ¤ ë©”ì†Œì™€ ${character_adventure_dungeon_earn_meso.toLocaleString("en-US")}ì˜ ë˜ì „ í´ë¦¬ì–´ ë©”ì†Œë¥¼ íšë“í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                        _tags.achived_trophy_count = createTag("p", "achived-trophy-count", "ğŸ† " + new String(achived_trophy_count));
                        _tags.dungeon_cleared_summation_score = createTag("p", "dungeon_cleared_summation_score", `ë˜ì „ ì¢…í•© ì ìˆ˜ : ${new String(dungeon_cleared_summation_score)} / ${new String(dungeon_cleared_summation_max_score)} (${dungeon_cleared_summation_percentage_decimal}% ì™„ì£¼, ì´ ${new String(dungeon_cleared_summation_count)}íšŒ í´ë¦¬ì–´)`);
                        //_tags.dungeon_cleared_summation_score_progress = createTag("progress", "progress_dungeon_cleared_summation_score", dungeon_cleared_summation_score,{"max":dungeon_cleared_summation_max_score,"value":dungeon_cleared_summation_score}); //progress bar may be added when supports coloring by css percentage values.
                        //homework
                        _tags.head_homework = createTag("h1", "head_homework", `ì¼ì¼ ìˆ™ì œ`);
                        _tags.additional_homework = createTag("p", "head_homework_comment", `(${today_year}ë…„ ${today_month}ì›” ${today_date}ì¼ ê¸°ì¤€, ì£¼ê°„ ìˆ™ì œ ì´ˆê¸°í™”ê¹Œì§€ ${str_remaining_day_diplay} ë‚¨ì•˜ìŠµë‹ˆë‹¤.)`);
                        _tags.test_dungeon_results = dungeon_cleared_records.reduce((a,c,i)=>{
                            //íƒœê·¸ ì¡°ë¦½ì— í•„ìš”í•œ ë³´ìŠ¤ ëª¬ìŠ¤í„°ì˜ ì´ë¦„ê³¼ í´ë¦¬ì–´ íšŸìˆ˜ ì¶”ì¶œ
                            let _dungeon_clear_records = {
                                "dungeon_name":c?.["dungeon_info"]?.["dungeonName"], 
                                //"dungeon_monster_id":c?.["dungeon_info"]?.  ["monsterId"],
                                "dungeon_clear_count":c?.["dungeon_cleared_amount"],
                                "dungeon_clear_count_unit" :"íšŒ",
                            };
                            console.log(_dungeon_clear_records);
                            let _tag_div_dungeon_record = Object.keys(_dungeon_clear_records).reduce((record_a, record_c, record_i)=>{
                                //íƒœê·¸ ì¡°ë¦½ 
                                let _tag_prop = createTag("span",new String(record_c),new String(_dungeon_clear_records?.[record_c]));
                                [_tag_prop].forEach((e)=>record_a.appendChild(e));
                                return record_a;}
                            , createTag("p", "test-dungeon-result-record"));
                            console.log("Tag c : ", _tag_div_dungeon_record);
                            a.appendChild(_tag_div_dungeon_record);
                            return a;}
                            , createTag("div", "test-dungeon-results"));
                        
                        Object.values(_tags).forEach((e)=>ch_root_div.appendChild(e)); // inject execution

                        // Step 4. inject made root to master div tag.
                        root_div.appendChild(ch_root_div);
                    }
                    
                    return ret_val;
                }
                


                //EXECUTION CODE (MAIN)
                readTextFile_Promise("./user_infos/userinfo.json")
                .then(parseFileToJSON)
                .then(JSONtoRender)


            </script>
        </div>
    </section>
</body>