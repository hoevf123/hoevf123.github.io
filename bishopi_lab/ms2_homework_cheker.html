<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>비숍이 실험실</title>
    <link rel="stylesheet" href="common.css">
    <script src="w3-include-html.js"></script>
    <style>
        div.ms2-info-block{
            border: 1px solid #333333;
            padding:15px;
            border-radius: 15px;
            
        }
    </style>
</head>

<body>
    <div w3-include-html="nav-header.html"></div>
    <section>
        <div class="div-content">
            <h1>숙제 검사기</h1>
            <p>메이플스토리의 숙제를 검사하는 프로그램(?)의 UI 테스트용 모형입니다.</p>
            <p>아래의 결과 값은 테스트 데이터이며, 실제 캐릭터 정보를 받아오도록 동작하는 기능을 구현하면, <a href="https://maplestory2.nexon.com/Content/html/pop_policy.html">메이플스토리2 운영정책</a>에 의해 계정 제제 조치가 취해질 수 있습니다.</p>
            <br/>
            
            <h2>숙제숙제</h2>
            <p>추후 추가하고 싶은 기능입니다.</p>
            <div class="ms2-frame border">
                <div class="ms2-frame homework-userinfo-display-area">
                    <h3>생성중...</h3>
                </div>
            </div>
            
            <!-- source code of createTag function -->
            <script type="text/javascript" src="createTag.js"></script>
            <!-- Data Warehouse from Python File-->
            <script>
                class DataWareHowse{
                    constructor(){
                        this.items={}
                    }
                    set(dict_keyworditems){
                        Object.assign(this.items, dict_keyworditems);
                    }
                    get(...key_names){
                        let multiple_argument_enable = true;
                        if(key_names.length<=1) multiple_argument_enable = false;
                        let ret_arrs = [];
                        for(let key in key_names){
                            key = key_names[key];
                            let ret_val = undefined;
                            try{
                                key = new String(key);
                                ret_val = this.items[key];
                            }catch(e){console.log(e);}
                            ret_arrs.push(ret_val);
                        }
                        ret_arrs = (multiple_argument_enable?ret_arrs:ret_arrs[0]); 
                        return ret_arrs;
                    }
                }
            </script>
            <!-- source code of character inventory implementation -->
            <script type="text/javascript">
                //DATA WAREHOUSE PREPARE
                const MAPLESTORY2_IMAGEPORTRAIT_DIR = "Maplestory2/Image/portrait/";

                let app_warehouse = new DataWareHowse();
                app_warehouse.set({
                    "img_tag_formats" : ["jpg", "jpeg", "png", "bmp", "gif", "webp"],
                    "str_jobclasses" : [
                                {"imgname" :"beginner", "name" : "초보자", "name-en" : "beginner"},
                                {"imgname" :"knight", "name" : "나이트", "name-en" : "knight"},
                                {"imgname" :"berserker", "name" : "버서커", "name-en" : "berserk"},
                                {"imgname" :"archer", "name" : "레인저", "name-en" : "archer"},
                                {"imgname" :"heavygunner", "name" : "헤비거너", "name-en" : "heavygunner"},
                                {"imgname" :"wizard", "name" : "위자드", "name-en" : "wizard"},
                                {"imgname" :"priest", "name" : "프리스트", "name-en" : "priest"},
                                {"imgname" :"thief", "name" : "시프", "name-en" : "thief"},
                                {"imgname" :"assassin", "name" : "어쌔신", "name-en" : "assasin"},
                                {"imgname" :"runeblader", "name" : "룬 블레이더", "name-en" : "runeblade"},
                                {"imgname" :"striker", "name" : "스트라이커", "name-en" : "striker"},
                                {"imgname" :"soulbinder", "name" : "소울바인더", "name-en" : "soulbind"}
                            ],
                    "data_bosses" : [
                            //50 Chaos Raid
                            {"dungeonType":"카오스 레이드", "dungeonName":"그림자 군단의 제단", "dungeonReqLevel":50, "monsterId" : 23200007, "monsterName" : "데보라크", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000007_b_devilhugeblue_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"달빛선장의 요새", "dungeonReqLevel":50, "monsterId" : 23200015, "monsterName" : "캡틴 모크", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/61000060_captainhookfish01_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"루디브리엄 시계탑", "dungeonReqLevel":50, "monsterId" : 23200077, "monsterName" : "파풀라투스", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000077_b_papulatus_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"루벨리스크", "dungeonReqLevel":50, "monsterId" : 23200068, "monsterName" : "바르칸트", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000068_b_barkhantblue_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"룬의 성전", "dungeonReqLevel":50, "monsterId" : 23200080, "monsterName" : "누타만" ,"dungeonClosed" : true, "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000080_b_titanfourarmsgoldmaskthirdfloor_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"비욘드 링크 트리스", "dungeonReqLevel":50, "monsterId" : 23200082, "monsterName" : "칸두라" ,"dungeonClosed" : true, "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000081_b_kanduranormal_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"불멸의 신전", "dungeonReqLevel":50, "monsterId" : 23290005, "monsterName" : "발록", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/02030005_balrog_p.png"},

                            //Rebirth Raid
                            {"dungeonType":"리버스 레이드", "dungeonName":"악마의 나무", "dungeonReqLevel":50, "monsterId" : 23000071, "monsterName" : "자쿰", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000071_b_zakumbrown_p.png"},
                            {"dungeonType":"리버스 레이드", "dungeonName":"이계의 존재", "dungeonReqLevel":56, "monsterId" : 23000088, "monsterName" : "핑크빈" ,"dungeonClosed" : true, "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000088_b_pinkbean_p.png"},
                            
                            //52~56 Chaos Raid
                            {"dungeonType":"카오스 레이드", "dungeonName":"서릿발 신전", "dungeonReqLevel":54, "monsterId" : undefined, "monsterName" : "비에른" ,"dungeonClosed" : true, "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000083_b_snowking_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"마드라칸 첨탑", "dungeonReqLevel":56, "monsterId" : 23200064, "monsterName" : "루카락스" ,"dungeonClosed" : true, "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000064_b_bigwingchimera_p.png"},


                            //Fortress Rumble
                            {"dungeonType":"포트리스 럼블", "dungeonName":"스카이 포트리스 함교 상층부", "dungeonReqLevel":50, "monsterId" : undefined, "monsterName" : "블리체", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "npc/11003533_f_bliche_p.png"},
                            {"dungeonType":"포트리스 럼블", "dungeonName":"트라이아 근위대 체력 단련장", "dungeonReqLevel":50, "monsterId" : undefined, "monsterName" : "콘대르", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "npc/11003534_m_conder_p.png"},
                            {"dungeonType":"포트리스 럼블", "dungeonName":"네이린의 전투 시뮬레이터", "dungeonReqLevel":50, "monsterId" : undefined, "monsterName" : "네이린", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "npc/11003536_f_neirin_p.png"},
                            {"dungeonType":"포트리스 럼블", "dungeonName":"기사단 고등 지휘부 접견 구역", "dungeonReqLevel":50, "monsterId" : undefined, "monsterName" : "메이슨", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "npc/11003537_m_mason_p.png"},
                            {"dungeonType":"포트리스 럼블", "dungeonName":"쉐도우윈드 비밀 훈련 시설", "dungeonReqLevel":50, "monsterId" : undefined, "monsterName" : "샤텐", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "npc/11003535_f_schatten_p.png"},
                                
                            //World Invaision
                            {"dungeonType":"월드 인베이전", "dungeonName":"인페르녹 최후의 방어선", "dungeonReqLevel":56, "monsterId" : undefined, "monsterName" : "인페르녹", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000090_b_balrogmagicburster_p.png"},
                            
                            //60 Chaos Raid
                            {"dungeonType":"카오스 레이드", "dungeonName":"서릿발 신전", "dungeonReqLevel":60, "monsterId" : 23000114, "monsterName" : "비에른", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000083_b_snowking_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"마드라칸 첨탑", "dungeonReqLevel":60, "monsterId" : 23200067, "monsterName" : "루카락스", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000064_b_bigwingchimera_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"이계의 존재", "dungeonReqLevel":60, "monsterId" : 23000115, "monsterName" : "핑크빈", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000088_b_pinkbean_p.png"},

                            //Eye Of Lapenta
                            {"dungeonType":"아이 오브 라펜타", "dungeonName":"에메랄드 프리즌", "dungeonReqLevel":60, "monsterId" : 23501001, "monsterName" : "유페리아", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23501001_b_yuperiarbladerdark_p.png"},
                            {"dungeonType":"아이 오브 라펜타", "dungeonName":"그레이브 블루", "dungeonReqLevel":60, "monsterId" : 23501011, "monsterName" : "렌듀비앙", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23501011_b_renduebianrbladerdark_p.png"},
                            {"dungeonType":"아이 오브 라펜타", "dungeonName":"터미너스 엔즈", "dungeonReqLevel":60, "monsterId" : 23000113, "monsterName" : "이슈라", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000113_b_ishurarbladerdark_p.png"},
                            {"dungeonType":"아이 오브 라펜타", "dungeonName":"블랙샤드 체임버", "dungeonReqLevel":60, "monsterId" : 23000118, "monsterName" : "이슈라", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000113_b_ishurarbladerdark_p.png"},

                            //70 Chaos Raid(Hard)
                            {"dungeonType":"카오스 레이드", "dungeonName":"고대 에네르 광산", "dungeonReqLevel":70, "monsterId" : 23000072, "monsterName" : "자쿰", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000071_b_zakumbrown_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"인페르녹 최후의 결전", "dungeonReqLevel":70, "monsterId" : 23000150, "monsterName" : "인페르녹", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000090_b_balrogmagicburster_p.png"},

                            //Santury of Darkness (Kritias Hard Dungeon)
                            {"dungeonType":"칠흑의 성전", "dungeonName":"숨겨진 격납고", "dungeonReqLevel":70, "monsterId" : 23503003, "monsterName" : "아르케온 카이", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/29500102_n_archeonblack_p.png"},
                            {"dungeonType":"칠흑의 성전", "dungeonName":"변절자 티마이온", "dungeonReqLevel":70, "monsterId" : 23504101, "monsterName" : "티마이온", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000103_b_timaion_p.png"},
                            {"dungeonType":"칠흑의 성전", "dungeonName":"음모의 전당", "dungeonReqLevel":70, "monsterId" : 23000122, "monsterName" : "투르카", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000120_b_turkahoodforce_p.png"},

                            //70 Chaos Raid(Hard) (Crack of Timespace, illusion Dungeon)
                            {"dungeonType":"카오스 레이드", "dungeonName":"환영의 푸른 그림자 동굴", "dungeonReqLevel":70, "monsterId" : 23500004, "monsterName" : "슈슈와 부부스", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000035_b_yetitwoheadgreen_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"환영의 호루스의 둥지", "dungeonReqLevel":70, "monsterId" : 23500006, "monsterName" : "호루스", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000021_b_griffonpharaoh01_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"우당탕 블랙빈 놀이터", "dungeonReqLevel":70, "monsterId" : 23000101, "monsterName" : "블랙빈", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000089_b_blackbean_p.png"},
                            {"dungeonType":"카오스 레이드", "dungeonName":"환영의 그림자 제단", "dungeonReqLevel":70, "monsterId" : 23200008, "monsterName" : "데보라크", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/61000050_devilhugeblue_p.png"},

                            {"dungeonType":"카오스 레이드", "dungeonName":"이계의 놀이터", "dungeonReqLevel":70, "monsterId" : 23000160, "monsterName" : "핑크빈", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000088_b_pinkbean_p.png"},
                            //2021-09-09 new dungeon. (2021-10-14 no longer recorded cleared rank)
                            //{"dungeonType":"카오스 레이드", "dungeonName":"푸른 화염의 혼돈", "dungeonReqLevel":70, "monsterId" : 23000400, "monsterName" : "블루 루크", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000400_b_blueluke_p.png"},
                            //2021-10-14 hard mode dungeon
                            {"dungeonType":"카오스 레이드", "dungeonName":"푸른 화염의 혼돈", "dungeonReqLevel":80, "monsterId" : 23000401, "monsterName" : "광기 어린 블루 루크", "thumbnailImage": MAPLESTORY2_IMAGEPORTRAIT_DIR + "mob/23000400_b_blueluke_p.png"},
                        ]
                });    

                //source copied from https://stackoverflow.com/questions/19706046/how-to-read-an-external-local-json-file-in-javascript
                /*
                // USAGE
                readTextFile("/Users/Documents/workspace/test.json", function(text){
                    var data = JSON.parse(text);
                    console.log(data);
                });
                */
                function readTextFile(file, callback) {
                    var rawFile = new XMLHttpRequest();
                    rawFile.overrideMimeType("application/json");
                    rawFile.open("GET", file, true);
                    rawFile.onreadystatechange = function() {
                        if (rawFile.readyState === 4 && rawFile.status == "200") {
                            callback(rawFile.responseText);
                        }
                    }
                    rawFile.send(null);
                }

                function readTextFile_Promise(fileName) {
                    return new Promise((resolve, reject)=>{
                        var rawFile = new XMLHttpRequest();
                        rawFile.overrideMimeType("application/json");
                        rawFile.open("GET", fileName, true);
                        rawFile.onreadystatechange = function() {
                            if (rawFile.readyState === 4 && rawFile.status == "200") {
                                resolve(rawFile.responseText);
                                console.log("1 Complete : ", rawFile.responseText);
                            }
                        }
                        rawFile.send(null);
                        //reject(null);
                    })
                    
                }

                

                // FILE READ CHECK
                

                // DEFINE RENDER METHOD AS PROMISE.
                function parseFileToJSON(text){
                    return new Promise((resolve, reject)=>{
                        try{
                            let jsonObject = JSON.parse(text);
                            console.log("2 Complete : ", jsonObject);
                            resolve(jsonObject);
                        }catch(e){
                            reject(e)
                        }
                    })
                }
                function JSONtoRender(json_data){
                    return new Promise((resolve, reject)=>{
                        let foo = document.getElementsByClassName("homework-userinfo-display-area"); // Root div elements.
                        // fit data
                        // make tag element(s)
                        // represent tags to the root div element(s).
                        //let assembled_html_tags=CreateSomething(json_data);
                        let assembled_html_tags=makeCharacterHTMLinfos(json_data);
                        console.log(assembled_html_tags);
                        Array.from(foo).forEach((e)=>{ 
                            e.innerHTML=""; //flush html elements
                            e.appendChild(assembled_html_tags);
                            //Array.from(assembled_html_tags[0]).forEach((result_elements)=>e.appendChild(result_elements));
                        });
                        console.log("3 Complete : ");
                        resolve(true);
                    })
                }
                let HTMLFrame_characeter_info = {
                    character_id:"p",
                    character_thumbnail_blob:"img",
                    trophy:"p"
                };
                const MAPLESTORY2_PROFILE_IMAGEPORTRAIT_DIR = undefined;
                const ICO_FILE_PREFIX = "ico"
                const ICO_FILE_EXTENSION = "png"
                const JOB_CLASS_IMGSRC_NAME_DICT = app_warehouse.get("str_jobclasses")?.reduce((a,c,i)=>{a.push([`${ICO_FILE_PREFIX}_${c["imgname"]}.${ICO_FILE_EXTENSION}`,c["name"]]); return a;},[]).reduce((a,c)=>{a[c[0]]=c[1]; return a;},{});
                console.log("hello, ",JOB_CLASS_IMGSRC_NAME_DICT);
                function get_filename(url){
                    const BACKSLASH = "\\";
                    const SLASH = "/";
                    let target_url = new String(url);
                    let pos_last_dir_loc = target_url.replace(BACKSLASH, SLASH).lastIndexOf(SLASH);
                    let ret_val = target_url.split(SLASH).pop();
                    return ret_val;
                }
                
                function replaceValueByKeyValue(target_value, keyValueSet){
                    if(!(keyValueSet instanceof Object))return target_value;
                    else return keyValueSet[target_value];
                }
                function get_job_class_name(img_url){
                    let ret_val = undefined;
                    try{
                        ret_val = replaceValueByKeyValue(img_url, JOB_CLASS_IMGSRC_NAME_DICT);
                    }catch(e){}
                    return ret_val;
                }
                function makeCharacterHTMLinfos(json_data){
                    let ret_val = undefined;
                    let root_div = document.createElement("div");
                    ret_val = root_div;

                    // 1-depth : id of chracter
                    for(ch_id in json_data){
                        // Step 1. get Data
                        let character_name = json_data[ch_id]?.character_name;
                        let character_thumbnail_image_blob = json_data[ch_id]?.character_thumbnail_image_blob;
                        let character_job_class = json_data[ch_id]?.character_job_class;
                        character_job_class = get_filename(character_job_class);
                        character_job_class = get_job_class_name(character_job_class);
                        let achived_trophy_count = json_data[ch_id]?.trophy;
                        let dungeon_cleared_records = json_data[ch_id]?.dungeon_cleared_records;
                        let dungeon_cleared_summation_count = dungeon_cleared_records.reduce((a,c,i)=>{a = a + Number(c?.dungeon_cleared_amount) ?? 0; console.log(c?.dungeon_cleared_amount); return a;}, 0);
                        let dungeon_cleared_summation_score = dungeon_cleared_records.reduce((a,c,i)=>{a = a + Math.min(Number(c?.dungeon_cleared_amount) ?? 0, 300); return a;}, 0);
                        let dungeon_cleared_summation_max_score = dungeon_cleared_records.reduce((a,c,i)=>{a = a + 300; return a;}, 0);
                        let today = new Date();
                        let today_year = today.getFullYear();
                        let today_month = today.getMonth() + 1;
                        let today_date = today.getDate();

                        let remaining_date = (7-(today.getDay()+2))%7;
                        // Step 2. make root div
                        let ch_root_div = createTag("div", "ms2-frame ms2-info-block " + new String(ch_id));
                        
                        // Step 3. inject fron data to HTML Tag Elements.
                        let _tags = {};
                        _tags.character_name = createTag("h1", "character-name",character_name);
                        _tags.character_thumbnail_image_blob = createTag("img", "characater_thumbnail_image");
                        _tags.character_thumbnail_image_blob.src = "data:image/png;base64,"+character_thumbnail_image_blob;
                        _tags.character_thumbnail_image_blob.alt = `characater_thumbnail_image(${new String(character_name)})`;
                        _tags.character_job_class=createTag("p","character-job-class","직업 : " + new String(character_job_class));
                        _tags.achived_trophy_count = createTag("p", "achived-trophy-count", "🏆 " + new String(achived_trophy_count));
                        _tags.dungeon_cleared_summation_score = createTag("p", "dungeon_cleared_summation_score", `던전 종합 점수 : ${new String(dungeon_cleared_summation_score)} / ${new String(dungeon_cleared_summation_max_score)} (총 ${new String(dungeon_cleared_summation_count)}회 클리어)`);
                        //homework
                        _tags.head_homework = createTag("h1", "head_homework", `일일 숙제`);
                        _tags.additional_homework = createTag("p", "head_homework_comment", `(${today_year}년 ${today_month}월 ${today_date}일 기준, 주간 숙제 초기화까지 ${remaining_date}일 남음)`);
                        
                        Object.values(_tags).forEach((e)=>ch_root_div.appendChild(e)); // inject execution

                        // Step 4. inject made root to master div tag.
                        root_div.appendChild(ch_root_div);
                    }
                    
                    return ret_val;
                }
                


                //EXECUTION CODE (MAIN)
                readTextFile_Promise("./user_infos/userinfo.json")
                .then(parseFileToJSON)
                .then(JSONtoRender)


            </script>
        </div>
    </section>
</body>