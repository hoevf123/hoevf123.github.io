<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <title>메이플2</title>
    <link rel="icon" href="메2 길드마크.png" type="image/png">
    <link rel="stylesheet" href="common.css">
    <script src="w3-include-html.js"></script>
</head>

<body>
    <div w3-include-html="nav-header.html"></div>
    <section>
        <div class="div-content">
            <h1>메이플스토리2 대미지 계산기</h1>
            <p>Helps to 벨붕 님</p>
            <br/>
            <p>계산된 대미지</p>
            <input type="button" value="계산" onclick="ms2_attack_gen.updateDamage()">
            <p class="ms2-damage-calculated-result">Damage Not Calculated</p>
            <div class="ms2-damage-check-generating-area"></div>

            <!-- origin source -->
            <script type="text/javascript" src="ms2_character_attack_status.js"></script>
            <!-- html tag maker -->
            <script>
                function createTag(element_name, class_name="", value=""){
                    element_name = String(element_name)||"";
                    let _tag = document.createElement(String(element_name));
                    _tag.className = class_name;
                    _tag.value = value;
                    switch(element_name){
                        case "input": _tag.name = value; break;
                        default:_tag.innerText=value;break;
                    }
                    return _tag;
                }

                class MS2DamageChecker{
                    constructor(target_div_classname, target_tag_update_area){
                        this.target_tag_update_area = target_tag_update_area;
                        this.connector_player_tag_form = {
                            //note : input default value or array of valueset
                            class: jobs,
                            weaponQuality: Object.keys(WeaponQualityBAModifier),
                            weaponAttack: 10767,
                            bonusAttack: 0,
                            petAttack: 0,
                            phyAttack: 13,
                            magAttack: 343,
                            piercing: 0,
                            phyPiercing: 0,
                            magPiercing: 0,
                            accuracy: 84,
                            critRate: 136,
                            critDamage: 167,
                            typedDamage: {
                                melee: 0.0,
                                ranged: 0.0,
                                fire: 0,
                                ice: 0,
                                electric: 0,
                                poison: 0,
                                dark: 0,
                                holy: 0,
                                boss: 4.0,
                                total: 0.0,
                            },
                            attackSpeed: 105.0,
                            skillCooltimeReduction: 0,
                        }

                        //create input form
                        this.connector_player_tag_connection = this.generatePlayerAttackCheckForm(target_div_classname,this.connector_player_tag_form)[1];

                        //create output form
                        //nothing();

                        //activate onchange

                    }
                    updateDamage(){
                        if(this.target_tag_update_area instanceof HTMLElement){
                            let dmg = this.calculate()
                            let _cl_tagname = String(this.target_tag_update_area.tagName).toLowerCase();
                            switch(_cl_tagname){
                                case "input":
                                case "select":
                                    this.target_tag_update_area.value=String(dmg);
                                    break;
                                default:
                                    this.target_tag_update_area.innerText=String(dmg);
                            }
                        }
                    }
                    calculate(){
                        let player_status = function ObjecetDOMToObjectValue(target_obj){
                            let ret_obj = {};
                            for(let a in target_obj){
                                function getValueFromTag(target_tag){
                                    if(!(target_tag instanceof HTMLElement)) return undefined;
                                    let tag_name = String(target_tag.tagName).toLowerCase();
                                    let ret_val = "";
                                    switch(tag_name){
                                        case "select":
                                        case "input":
                                            if(target_tag.type=="number")
                                                ret_val = Number(target_tag.value);
                                            else
                                                ret_val = String(target_tag.value);
                                            break;
                                        default:
                                            ret_val = String(target_tag.innerText);
                                            break;
                                    }
                                    return ret_val;
                                }
                                if(target_obj[a] instanceof HTMLElement){
                                    ret_obj[a]=getValueFromTag(target_obj[a]);
                                }
                                else{
                                    //it's object(nested) hiarchy
                                    ret_obj[a]=ObjecetDOMToObjectValue(target_obj[a]);
                                }
                            }
                            return ret_obj;
                        }(this.connector_player_tag_connection);
                        console.log(player_status);
                        return calc(player_status);

                    }
                    generatePlayerAttackCheckForm(target_tagname, connector_player_tag_sample){
                        let target_tags = document.getElementsByClassName(target_tagname);
                        if(target_tags === undefined) return;

                        function CreateSomething(connector_player_tag_sample){
                            let assembled_tags = [];
                            let connector_player_tag_connection = {};
                            for(let arg_name in connector_player_tag_sample){
                                let object_stack = [];
                                // create header tag
                                let header_tag = createTag("p","",arg_name);
                                let content_tag = null;

                                let arg_content = connector_player_tag_sample[arg_name];
                                let arg_content_type =typeof(arg_content);
                                console.log("Current Seeing content : ", arg_content);
                                if(!(arg_content_type == "number" || arg_content_type == "object" || arg_content_type == "string"))continue;
                                if(arg_content instanceof Array){
                                    //create select box list
                                    let tag_selectbox = createTag("select",arg_name);
                                    let tag_options = Array.prototype.reduce.call(arg_content,function(a,c){
                                        a.push(createTag("option",arg_name,c));
                                        return a;
                                    },[]);
                                    //insert options to selectbox
                                    tag_options.forEach(element => {
                                        tag_selectbox.appendChild(element);
                                    });
                                    //indicates content tag
                                    content_tag = tag_selectbox;
                                }
                                else if(typeof(arg_content) == "number" || typeof(arg_content) == "string"){ 
                                    let tag_inputbox = createTag("input",arg_name,arg_content);
                                    if(typeof(arg_content) == "number") tag_inputbox.type="number";
                                    //indicates content tag
                                    content_tag = tag_inputbox;
                                }
                                else{
                                    //nested object(s)
                                    let tag_div = createTag("div",arg_name);
                                    let ret_vals = CreateSomething(arg_content);
                                    let ret_tagset = ret_vals[0];
                                    let ret_connetor_player_tag_connection = ret_vals[1];
                                    if(ret_vals instanceof Array){
                                        ret_tagset.forEach((e)=>tag_div.appendChild(e));
                                        connector_player_tag_connection[arg_name]=ret_connetor_player_tag_connection;
                                        content_tag =tag_div;
                                    }
                                    
                                }
                                
                                //insert tag when acontent tag is well created
                                console.log("header_tag", header_tag, "content_tag " , content_tag);
                                if(header_tag instanceof HTMLElement && content_tag instanceof HTMLElement){
                                    if(connector_player_tag_connection[header_tag.value]===undefined)
                                        connector_player_tag_connection[header_tag.value]=content_tag;
                                    assembled_tags.push(header_tag);
                                    assembled_tags.push(content_tag);
                                }
                            }

                            return [assembled_tags, connector_player_tag_connection];
                        }
                        
                        let ret_vals = CreateSomething(connector_player_tag_sample);
                        let assembled_tags =ret_vals[0];
                        let connector_player_tag_connection = ret_vals[1];
                        //attatch the created form
                        console.log(assembled_tags);
                        Array.prototype.forEach.call(target_tags,
                        function(e){
                            assembled_tags.forEach(function(a){
                                e.appendChild(a);
                            });
                        });

                        return [assembled_tags, connector_player_tag_connection];
                    }
                }
                
                //connector of tag
                

                //create auto inputbox or select box to generate
                let className_generate_area = "ms2-damage-check-generating-area";
                let tag_dmg_result = document.getElementsByClassName("ms2-damage-calculated-result")[0];
                let ms2_attack_gen = new MS2DamageChecker(className_generate_area, tag_dmg_result);
                
            </script>
            
        </div>
    </section>
</body>